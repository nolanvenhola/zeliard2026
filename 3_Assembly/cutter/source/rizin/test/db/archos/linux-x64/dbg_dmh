NAME=use of dmh, then any command which use grep and index
FILE=bins/elf/simple_malloc_x86_64
ARGS=-d
CMDS=<<EOF
db @ sym.main
dc
dmh > /dev/null
aa > /dev/null
dr r13=rip
pdf @ sym.main~:4
EOF
EXPECT=<<EOF
/ int main(int argc, char **argv, char **envp);
EOF
RUN

NAME=dmh allocated
FILE=bins/elf/simple_malloc_x86_64
ARGS=-d
CMDS=<<EOF
(dmh_tail n; dmh~:-${n}.. | sed 's/11c\|120/1__/;  s/xf1\|xed/x__/')
dcu main
.(dmh_tail 2)
echo ----
7dso
.(dmh_tail 3)
EOF
REGEXP_FILTER_OUT=(status=[a-z]+)|(size=0x[_a-f0-9]+)
EXPECT=<<EOF
status=allocated
size=0x1__10
status=free
size=0x__60
status=allocated
size=0x1__10
status=allocated
size=0x20
status=free
size=0x__40
EOF
RUN

NAME=dmh/dmha with memory dump
FILE=bins/heap/linux_glibc-2.30_x64.bin
ARGS=-n
CMDS=<<EOF
#re-map arena and [heap]
om 3 0x7ffff7f8a000 0x898 0x0 rw- arena
om 3 0x555555559000 0x3200 0x898 rw- [heap]

dmha~?0x7ffff7f8a000
e dbg.glibc.tcache=0
dmh~?allocated
e dbg.glibc.tcache=1
dmh~?allocated
EOF
EXPECT=<<EOF
1
3
2
EOF
RUN

NAME=dmht with memory dump
FILE=bins/heap/linux_glibc-2.30_x64.bin
ARGS=-n
CMDS=<<EOF
#re-map arena and [heap]
om 3 0x7ffff7f8a000 0x898 0x0 rw- arena
om 3 0x555555559000 0x3200 0x898 rw- [heap]

e dbg.glibc.tcache=0
dmht~?Items[2]
e dbg.glibc.tcache=1
dmht~?Items[2]
EOF
EXPECT=<<EOF
0
1
EOF
RUN

NAME=dmhl with memory dump
FILE=bins/heap/linux_glibc-2.30_x64.bin
ARGS=-n
CMDS=<<EOF
#re-map arena and [heap]
om 3 0x7ffff7f8a000 0x898 0x0 rw- arena
om 3 0x555555559000 0x3200 0x898 rw- [heap]

dmhl~?0x7ffff7f8a000
e dbg.glibc.tcache=0
dmhl~?0x555555559000
dmhl~?0x555555559010
e dbg.glibc.tcache=1
dmhl~?0x555555559000
dmhl~?0x55555555c1a0
dmhl~?0x55555555c1c0
EOF
EXPECT=<<EOF
1
2
1
1
1
1
EOF
RUN

NAME=check dmhf
FILE=bins/elf/glibc-heap-2.31
ARGS=-Rsetenv=LD_PRELOAD=bins/elf/libc-2.31.so -d
CMDS=<<EOF
db @ 0x004011fa
dc
dmhf~?Chunk
dmhf 1~?Chunk
dmhf 2~?Chunk
dmhf 3~?Chunk
EOF
EXPECT=<<EOF
8
8
0
0
EOF
RUN

NAME=dmhc with memory dump
FILE=bins/heap/linux_glibc-2.30_x64.bin
ARGS=-n
CMDS=<<EOF
#re-map arena and [heap]
om 3 0x7ffff7f8a000 0x898 0x0 rw- arena
om 3 0x555555559000 0x3200 0x898 rw- [heap]
e dbg.glibc.tcache=1
dmhc @ 0x555555559290~?0x20
dmhc @ 0x555555559290~?0x555555559010
dmhc @ 0x55555555c1a0~?0x1a0a
dmhc @ 0x5555555592b0~?0x2ef0
EOF
EXPECT=<<EOF
1
1
1
1
EOF
RUN

NAME=dmhb/dmhg/dmhm
FILE=bins/elf/glibc-heap-2.31
ARGS=-Rsetenv=LD_PRELOAD=bins/elf/libc-2.31.so -d
CMDS=<<EOF
db @ 0x004011fa
dc
dmhb~Bin 000:?
dmhg~Top?
dmhm~Large?
EOF
EXPECT=<<EOF
1
1
1
EOF
RUN

NAME=dmhb/dmhg/dmhm
FILE=bins/elf/glibc-heap-2.31
ARGS=-Rsetenv=LD_PRELOAD=bins/elf/libc-2.31.so -d
CMDS=<<EOF
db @ 0x004011fa
dc
dmhb~Bin 000:?
dmhg~Top?
dmhm~Large?
EOF
EXPECT=<<EOF
1
1
1
EOF
RUN

NAME=multi-arena dmha/dmhi
FILE=bins/heap/multi-arena-glibc-2.31-amd64
ARGS=-d
CMDS=<<EOF
dc
dmha~Thread?
$arena=$`dmha | grep "Thread arena" | head -1 | awk -F'addr=' '{print $2}' | awk -F',' '{print $1}'`
dmhi `$arena`~?malloc_info
EOF
REGEXP_FILTER_OUT=(?m)^[[:space:]]*\K([0-9]+|----)(?=[[:space:]]*$)
EXPECT=<<EOF
4
1
EOF
RUN
