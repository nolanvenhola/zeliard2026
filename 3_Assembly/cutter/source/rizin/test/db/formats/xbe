NAME=iH and iI
FILE=bins/xbe/nxdk-hello-dummy-libs.xbe
CMDS=<<EOF
iH
echo ---
iI
EOF
EXPECT=<<EOF
xbe:
  identity:
    magic: "58 42 45 48                                     |XBEH            |"
    signature: |
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
      00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................|
    timestamp: 1658843531
  memory:
    base: 0x10000
    headers_size: 1497
    image_size: 110868
    image_header_size: 376
    entry_point: 0xa8fdc4cb
    tls_addr: 0x26050
  sections:
    count: 4
    header_addr: 0x10348
  pe_data:
    - 0x10000
    - 0x100000
    - 0x1000
    - 0x10000
    - 0x1c000
    - 0x0
    - 0x62dff175
  debug:
    path_addr: 0x1048a
    name_addr: 0x1048a
    uname_addr: 0x1048a
  libraries:
    count: 4
    versions_addr: 0x1044a
    kernel_addr: 0x0
    xapi_addr: 0x0
    kernel_thunk_addr: 0x5b6f3bd2
    nonkernel_import_dir_addr: 0x0
  misc:
    init_flags: 5
    padding:
      - 0x10490
      - 0x149
  sections_detail:
    - flags:
        value: 6
        readable: "PRELOAD | EXEC"
      vaddr: 0x11000
      vsize: 81920
      offset: 4096
      size: 79872
      name_addr: 0x10432
      refcount: 0
      padding:
        - 0x10428
        - 0x1042a
      digest: "00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00"
    - flags:
        value: 2
        readable: "PRELOAD"
      vaddr: 0x25000
      vsize: 12288
      offset: 86016
      size: 11408
      name_addr: 0x10438
      refcount: 0
      padding:
        - 0x1042a
        - 0x1042c
      digest: "00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00"
    - flags:
        value: 3
        readable: "WRITE | PRELOAD"
      vaddr: 0x28000
      vsize: 12288
      offset: 98304
      size: 3380
      name_addr: 0x1043f
      refcount: 0
      padding:
        - 0x1042c
        - 0x1042e
      digest: "00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00"
    - flags:
        value: 3
        readable: "WRITE | PRELOAD"
      vaddr: 0x2b000
      vsize: 276
      offset: 102400
      size: 4
      name_addr: 0x10445
      refcount: 0
      padding:
        - 0x1042e
        - 0x10430
      digest: "00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00"
  libraries_detail:
    - name: "RIZIN0"
      major: 42
      minor: 5
      build: 0
      flags: 0
    - name: "RIZIN1"
      major: 42
      minor: 6
      build: 1
      flags: 0
    - name: "RIZIN2"
      major: 42
      minor: 7
      build: 2
      flags: 0
    - name: "RIZIN3"
      major: 42
      minor: 8
      build: 3
      flags: 0

---
arch     x86
cpu      N/A
features N/A
baddr    0x00010000
binsz    0x0001a000
bintype  N/A
bits     32
retguard false
class    program
compiler N/A
dbg_file N/A
endian   LE
hdr.csum N/A
guid     N/A
intrp    N/A
laddr    0x00000000
lang     N/A
machine  Microsoft Xbox
maxopsz  16
minopsz  1
os       xbox
cc       N/A
pcalign  1
rpath    N/A
subsys   
stripped false
crypto   false
havecode true
va       true
sanitiz  false
static   false
linenum  false
lsyms    false
canary   false
PIE      false
RELROCS  false
NX       false
EOF
RUN

NAME=entrypoint decoding
FILE=bins/xbe/default.xbe
CMDS=ie
EXPECT=<<EOF
     vaddr      paddr     hvaddr      haddr type    
----------------------------------------------------
0x00011000 0x00001000 ---------- ---------- program
EOF
RUN

NAME=corrupted section data
FILE=bins/xbe/default.xbe
CMDS=p8 16
EXPECT=<<EOF
81ec08040000535556576a01e88f0100
EOF
RUN

NAME=decoding the thunk table
FILE=bins/xbe/default.xbe
CMDS=is
EXPECT=<<EOF
nth      paddr      vaddr bind type size lib name       
--------------------------------------------------------
  0 0x000016c0 0x000116c0 NONE NONE    4     kt.sprintf
EOF
RUN

NAME=section header decoding
BROKEN=1
FILE=bins/xbe/default.xbe
CMDS=iS
EXPECT=<<EOF
[Sections]
00 0x00001000  1728 0x00011000  1728 -r-x .0
01 0x00002000    24 0x000116c0    24 -r-- .1
02 0x00003000 28280 0x000116e0 1257188 -rw- .2
03 0x0000a000    60 0x001445e0    64 -rwx .3
04 0x0000b000   164 0x00144620  1188 -r-- .4
EOF
RUN

NAME=section header in r2
BROKEN=1
FILE=bins/xbe/default.xbe
CMDS=S
EXPECT=<<EOF
[00:00] * pa=0x00001000 r-x va=0x00011000 sz=0x06c0 vsz=0x06c0 .0
[00:01] . pa=0x00002000 r-- va=0x000116c0 sz=0x0018 vsz=0x0018 .1
[00:02] . pa=0x00003000 rw- va=0x000116e0 sz=0x6e78 vsz=0x132ee4 .2
[00:03] . pa=0x0000a000 rwx va=0x001445e0 sz=0x003c vsz=0x0040 .3
[00:04] . pa=0x0000b000 r-- va=0x00144620 sz=0x00a4 vsz=0x04a4 .4
EOF
RUN

NAME=loading crashy xbe file
FILE=bins/xbe/crash.xbe
CMDS=q!
EXPECT=
RUN

NAME=xbe library versions
FILE=bins/xbe/nxdk-hello-dummy-libs.xbe
CMDS=il
EXPECT=<<EOF
library       
--------------
RIZIN0 42.5.0
RIZIN1 42.6.1
RIZIN2 42.7.2
RIZIN3 42.8.3
EOF
RUN
